{% extends 'base_sidebar.html' %}
{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<style>
  .calendar-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .fc-event {
    cursor: pointer;
    border: none !important;
    padding: 2px 4px;
    margin-bottom: 2px;
    font-size: 0.85em;
  }
  
  .fc-event-free {
    background-color: #22c55e !important;
    color: white !important;
  }
  
  .fc-event-paid {
    background-color: #3b82f6 !important;
    color: white !important;
  }
  
  .fc-daygrid-day:hover {
    background-color: #f8f9fa;
  }
  
  .fc-day-today {
    background-color: #fff3cd !important;
  }
  
  .mobile-event-list {
    display: none;
  }
  
  @media (max-width: 768px) {
    .calendar-container {
      display: none;
    }
    .mobile-event-list {
      display: block;
    }
  }
  
  {% if user.is_authenticated and user.registration_status != 'payment_verified' and user.rank != 'admin' %}
  .calendar-container, .mobile-event-list {
    filter: blur(6px) brightness(0.8);
    pointer-events: none;
    user-select: none;
  }
  {% endif %}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="position-relative">
    {% if user.is_authenticated and user.registration_status != 'payment_verified' and user.rank != 'admin' %}
      <div id="event-blur-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; backdrop-filter: blur(6px) brightness(0.8); background: rgba(255,255,255,0.6); display: flex; align-items: center; justify-content: center; border-radius: 8px;">
        <div class="text-center p-4">
          <div style="font-size: 4rem; color: #888;"><i class="fas fa-lock"></i></div>
          <h3 class="fw-bold mt-3">Events Locked</h3>
          <p class="lead">You need to have your registration payment verified by an admin to access events and activities.</p>
          <a href="{% url 'accounts:profile' %}" class="btn btn-primary btn-lg">Complete Registration Payment</a>
        </div>
      </div>
    {% endif %}
    
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Events & Activities</h2>
      {% if user.is_admin %}
        <a href="{% url 'events:event_create' %}" class="btn btn-success">
          <i class="fas fa-plus me-2"></i>Create Event
        </a>
      {% endif %}
    </div>
    
    <!-- Calendar View (Desktop/Tablet) -->
    <div class="calendar-container">
      <div id="calendar"></div>
    </div>
    
    <!-- Mobile List View -->
    <div class="mobile-event-list">
      <div class="row g-4">
        {% if events %}
          {% for event in events %}
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h5 class="card-title mb-2">{{ event.title }}</h5>
                      <p class="card-text text-muted mb-2">{{ event.description|truncatechars:100 }}</p>
                      <div class="mb-1">
                        <i class="fas fa-calendar-alt me-1"></i>
                        <small>{{ event.date|date:"M d, Y" }}</small>
                      </div>
                      <div class="mb-1">
                        <i class="fas fa-clock me-1"></i>
                        <small>{{ event.time|time:"P" }}</small>
                      </div>
                      <div class="mb-2">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        <small>{{ event.location }}</small>
                      </div>
                      {% if event.payment_amount %}
                        <span class="badge bg-primary">₱{{ event.payment_amount }}</span>
                      {% else %}
                        <span class="badge bg-success">Free</span>
                      {% endif %}
                    </div>
                  </div>
                  <a href="{% url 'events:event_detail' event.pk %}" class="btn btn-outline-primary btn-sm mt-2">
                    View Details
                  </a>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="col-12">
            <div class="alert alert-info">No events scheduled.</div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var calendarEl = document.getElementById('calendar');
  var isAdmin = {{ user.is_admin|yesno:"true,false" }};
  
  var events = [
    {% for event in events %}
    {
      id: '{{ event.pk }}',
      title: '{{ event.title|escapejs }}',
      start: '{{ event.date|date:"Y-m-d" }}T{{ event.time|time:"H:i" }}',
      url: '{% url "events:event_detail" event.pk %}',
      extendedProps: {
        amount: {% if event.payment_amount %}'₱{{ event.payment_amount }}'{% else %}null{% endif %},
        isFree: {% if event.payment_amount %}false{% else %}true{% endif %},
        location: '{{ event.location|escapejs }}',
        time: '{{ event.time|time:"g:i A" }}'
      },
      className: {% if event.payment_amount %}'fc-event-paid'{% else %}'fc-event-free'{% endif %}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  
  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: ''
    },
    events: events,
    eventContent: function(arg) {
      // Get all events for this day
      var dayEvents = calendar.getEvents().filter(function(e) {
        return e.startStr.split('T')[0] === arg.event.startStr.split('T')[0];
      });
      
      var container = document.createElement('div');
      container.className = 'fc-event-main-frame';
      
      if (dayEvents.length >= 3) {
        // Show count if 3+ events
        var index = dayEvents.findIndex(e => e.id === arg.event.id);
        if (index < 2) {
          // Show first 2 events normally
          var title = document.createElement('div');
          title.className = 'fc-event-title';
          title.innerHTML = '<strong>' + arg.event.title + '</strong>';
          container.appendChild(title);
        } else if (index === 2) {
          // Show "n events" for the rest
          var remaining = dayEvents.length - 2;
          var count = document.createElement('div');
          count.className = 'fc-event-title';
          count.innerHTML = '<strong>+' + remaining + ' more event' + (remaining > 1 ? 's' : '') + '</strong>';
          container.appendChild(count);
          return { domNodes: [container] };
        } else {
          // Hide events after the 3rd
          return { domNodes: [] };
        }
      } else {
        // Show event title and time
        var title = document.createElement('div');
        title.className = 'fc-event-title';
        title.innerHTML = '<strong>' + arg.event.title + '</strong>';
        container.appendChild(title);
        
        var time = document.createElement('div');
        time.className = 'fc-event-time';
        time.style.fontSize = '0.75em';
        time.innerHTML = arg.event.extendedProps.time;
        container.appendChild(time);
        
        if (arg.event.extendedProps.amount) {
          var amount = document.createElement('div');
          amount.className = 'fc-event-amount';
          amount.style.fontSize = '0.75em';
          amount.innerHTML = arg.event.extendedProps.amount;
          container.appendChild(amount);
        }
      }
      
      return { domNodes: [container] };
    },
    dateClick: function(info) {
      // Only admins can create events by clicking empty days
      if (isAdmin) {
        // Check if clicked day has events
        var hasEvents = calendar.getEvents().some(function(e) {
          return e.startStr.split('T')[0] === info.dateStr;
        });
        
        if (!hasEvents) {
          // Redirect to create event with date pre-filled
          window.location.href = '{% url "events:event_create" %}?date=' + info.dateStr;
        }
      }
    },
    eventClick: function(info) {
      info.jsEvent.preventDefault();
      // Navigate to event detail
      if (info.event.url) {
        window.location.href = info.event.url;
      }
    },
    height: 'auto',
    contentHeight: 650,
    aspectRatio: 1.8
  });
  
  calendar.render();
});
</script>
{% endblock %} 