{% extends 'base_sidebar.html' %}

{% block content %}
<!-- Toast Notification Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11000;">
  {% if messages %}
    {% for message in messages %}
      <div class="toast align-items-center text-white border-0 bg-{% if message.tags == 'error' %}danger{% elif message.tags == 'warning' %}warning{% elif message.tags == 'info' %}info{% elif message.tags == 'success' %}success{% else %}primary{% endif %}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="4000">
        <div class="d-flex">
          <div class="toast-body">
            <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %} me-2"></i>
            {{ message }}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    {% endfor %}
  {% endif %}
</div>

<div class="container py-4 position-relative">
  {% if user.is_authenticated and user.registration_status != 'payment_verified' and user.rank != 'admin' %}
    <div id="event-blur-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; backdrop-filter: blur(6px) brightness(0.8); background: rgba(255,255,255,0.6); display: flex; align-items: center; justify-content: center;">
      <div class="text-center">
        <div style="font-size: 4rem; color: #888;"><i class="fas fa-lock"></i></div>
        <h3 class="fw-bold mt-3">Event Locked</h3>
        <p class="lead">You need to have your registration payment verified by an admin to join or view event details.</p>
        <p class="text-muted">Please complete your payment and wait for admin approval to unlock this feature.</p>
      </div>
    </div>
  {% endif %}
  <div class="row">
    <!-- Event Information -->
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h2 class="card-title">{{ event.title }}</h2>
          
          {% if event.banner %}
            <img src="{{ event.banner.url }}" alt="Event Banner" class="img-fluid mb-3" style="max-width: 100%;">
          {% endif %}
          
          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Date:</strong> {{ event.date|date:"F d, Y" }}<br>
              <strong>Time:</strong> {{ event.time|time:"g:i A" }}<br>
              <strong>Location:</strong> {{ event.location }}
            </div>
            <div class="col-md-6">
              <strong>Created by:</strong> {{ event.created_by.get_full_name }}<br>
              <strong>Created:</strong> {{ event.created_at|date:"F d, Y" }}
            </div>
          </div>
          
          <div class="mb-3">
            <strong>Description:</strong><br>
            {{ event.description|linebreaks }}
          </div>

          <!-- Payment Information -->
          {% if event.has_payment_required %}
            <div class="alert alert-info">
              <h5><i class="fas fa-credit-card"></i> Payment Required</h5>
              <p class="mb-0"><strong>Event Fee:</strong> ₱{{ event.payment_amount }}</p>
              <p class="mt-2 mb-0">
                <i class="fas fa-mobile-alt"></i> 
                <small>Payment will be processed via PayMongo (GCash or Maya). You'll be redirected to complete payment after registration.</small>
              </p>
            </div>
          {% else %}
            <div class="alert alert-success">
              <h5><i class="fas fa-check-circle"></i> Free Event</h5>
              <p class="mb-0">No payment required for this event.</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Registration Section -->
      {% if user.is_authenticated %}
        <div class="card shadow-sm mb-4">
          <div class="card-header">
            <h5 class="mb-0">Event Registration</h5>
          </div>
          <div class="card-body">
            {% if registration %}
              <div class="alert alert-info">
                <h6>Your Registration Status</h6>
                <p><strong>RSVP:</strong> {{ registration.get_rsvp_display }}</p>
                <p><strong>Payment Status:</strong> 
                  <span class="badge {% if registration.payment_status == 'paid' %}bg-success{% elif registration.payment_status == 'partial' %}bg-info{% elif registration.payment_status == 'pending' %}bg-warning{% elif registration.payment_status == 'rejected' %}bg-danger{% else %}bg-secondary{% endif %}">
                    {{ registration.get_payment_status_display }}
                  </span>
                </p>
                {% if event.has_payment_required %}
                  <p><strong>Amount Required:</strong> ₱{{ registration.amount_required }}</p>
                  <p><strong>Amount Paid:</strong> ₱{{ registration.total_paid }}</p>
                  <p><strong>Amount Remaining:</strong> ₱{{ registration.amount_remaining }}</p>
                {% endif %}
                {% if registration.payment_notes %}
                  <p><strong>Admin Notes:</strong> {{ registration.payment_notes }}</p>
                {% endif %}
                {% if registration.verified_by %}
                  <p><strong>Verified by:</strong> {{ registration.verified_by.get_full_name }} on {{ registration.verification_date|date:"F d, Y" }}</p>
                {% endif %}
              </div>
              
              <!-- Payment Status (PayMongo) -->
              {% if event.has_payment_required and user_payments %}
                <div class="mb-3">
                  <h6><i class="fas fa-receipt"></i> Payment Status</h6>
                  {% for payment in user_payments %}
                    {% if payment.payment_method != 'manual' %}
                      <div class="alert {% if payment.status == 'verified' %}alert-success{% elif payment.status == 'failed' or payment.status == 'rejected' %}alert-danger{% else %}alert-warning{% endif %} mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                          <div>
                            <strong>₱{{ payment.amount }}</strong> - 
                            {% if payment.payment_method == 'paymongo_gcash' %}
                              <i class="fas fa-wallet"></i> GCash
                            {% elif payment.payment_method == 'paymongo_maya' %}
                              <i class="fas fa-mobile-alt"></i> Maya
                            {% endif %}
                          </div>
                          <span class="badge {% if payment.status == 'verified' %}bg-success{% elif payment.status == 'failed' or payment.status == 'rejected' %}bg-danger{% else %}bg-warning{% endif %}">
                            {{ payment.get_status_display }}
                          </span>
                        </div>
                        <small class="text-muted d-block mt-1">
                          <i class="fas fa-calendar"></i> {{ payment.created_at|date:"M d, Y g:i A" }}
                        </small>
                        
                        <!-- Pay Now Button for Pending Payments -->
                        {% if payment.status == 'pending' and payment.paymongo_source_id and payment.paymongo_checkout_url %}
                          <a href="{{ payment.paymongo_checkout_url }}" target="_blank" id="pay-now-btn" class="btn btn-primary btn-lg mt-3 w-100 pulse-animation">
                            <i class="fas fa-credit-card"></i> Pay Now via 
                            {% if payment.payment_method == 'paymongo_gcash' %}GCash
                            {% elif payment.payment_method == 'paymongo_maya' %}Maya{% endif %}
                          </a>
                          <small class="text-success d-block mt-2 fw-bold">
                            <i class="fas fa-arrow-up"></i> Click the button above to complete your payment
                          </small>
                        {% elif payment.status == 'pending' and payment.paymongo_source_id and not payment.paymongo_checkout_url %}
                          <div class="alert alert-info mt-2 mb-0">
                            <small>
                              <i class="fas fa-info-circle"></i> Payment link expired or unavailable. Please contact admin or re-register for the event.
                            </small>
                          </div>
                        {% endif %}
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
              
              <!-- Update Registration Form -->
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="register_event" value="1">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ registration_form.rsvp.id_for_label }}" class="form-label">RSVP</label>
                      {{ registration_form.rsvp }}
                    </div>
                  </div>
                  {% if event.has_payment_required %}
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Payment Method</label>
                      {% for choice in registration_form.payment_method %}
                        <div class="form-check">
                          {{ choice.tag }}
                          <label class="form-check-label" for="{{ choice.id_for_label }}">
                            <i class="fas {% if 'gcash' in choice.choice_label|lower %}fa-wallet{% elif 'grab' in choice.choice_label|lower %}fa-car{% else %}fa-mobile-alt{% endif %} me-1"></i>
                            {{ choice.choice_label }}
                          </label>
                        </div>
                      {% endfor %}
                      {% if registration_form.payment_method.help_text %}
                        <div class="form-text">{{ registration_form.payment_method.help_text }}</div>
                      {% endif %}
                    </div>
                  </div>
                  {% endif %}
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-edit me-1"></i> Update Registration
                </button>
              </form>
            {% else %}
              <!-- New Registration Form -->
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="register_event" value="1">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ registration_form.rsvp.id_for_label }}" class="form-label">RSVP</label>
                      {{ registration_form.rsvp }}
                    </div>
                  </div>
                  {% if event.has_payment_required %}
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Payment Method</label>
                      {% for choice in registration_form.payment_method %}
                        <div class="form-check">
                          {{ choice.tag }}
                          <label class="form-check-label" for="{{ choice.id_for_label }}">
                            <i class="fas {% if 'gcash' in choice.choice_label|lower %}fa-wallet{% elif 'grab' in choice.choice_label|lower %}fa-car{% else %}fa-mobile-alt{% endif %} me-1"></i>
                            {{ choice.choice_label }}
                          </label>
                        </div>
                      {% endfor %}
                      {% if registration_form.payment_method.help_text %}
                        <div class="form-text">{{ registration_form.payment_method.help_text }}</div>
                      {% endif %}
                    </div>
                  </div>
                  {% endif %}
                </div>
                <button type="submit" class="btn btn-success">
                  <i class="fas fa-check-circle me-1"></i> Register for Event
                </button>
              </form>
            {% endif %}
          </div>
        </div>

        <!-- Student Attendance Section -->
        {% if registration and registration.payment_status in 'not_required,paid' %}
        <div class="card shadow-sm mb-4" id="attendance-card">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-check-square"></i> Mark Your Attendance</h5>
          </div>
          <div class="card-body text-center">
            <div id="attendance-status-message">
              <p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Checking attendance status...</p>
            </div>
            <button type="button" id="mark-attendance-btn" class="btn btn-success btn-lg" style="display: none;">
              <i class="fas fa-user-check"></i> Mark My Attendance
            </button>
            <div id="attendance-success-message" style="display: none;">
              <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> <strong>Attendance Marked!</strong>
                <p class="mb-0">Your attendance has been recorded successfully.</p>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      {% endif %}

      <!-- Admin Section -->
      {% if user.is_admin %}
        <div class="card shadow-sm mb-4">
          <div class="card-header">
            <h5 class="mb-0">Admin Controls</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <a href="{% url 'events:event_edit' event.pk %}" class="btn btn-warning mb-2 w-100">
                  <i class="fas fa-edit"></i> Edit Event
                </a>
                <a href="{% url 'events:event_attendance' event.pk %}" class="btn btn-info mb-2 w-100">
                  <i class="fas fa-clipboard-check"></i> Manage Attendance
                </a>
              </div>
              <div class="col-md-6">
                <a href="{% url 'events:photo_upload' event.pk %}" class="btn btn-secondary mb-2 w-100">
                  <i class="fas fa-camera"></i> Upload Photos
                </a>
                {# <a href="{% url 'events:upload_certificate_template' event.pk %}" class="btn btn-primary mb-2 w-100">
                  <i class="fas fa-certificate"></i> Certificate Template
                </a> #}
              </div>
            </div>
          </div>
        </div>

        <!-- Attendance Session Controls (Admin) -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-user-check"></i> Attendance Session Control</h5>
          </div>
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-6">
                <h6>Session Status: <span id="admin-session-status" class="badge bg-secondary">Checking...</span></h6>
                <p class="mb-2">
                  <strong>Attendance Count:</strong> <span id="admin-attendance-count" class="badge bg-info">0</span>
                </p>
                <p class="text-muted small mb-0">
                  <i class="fas fa-info-circle"></i> Start the session to allow students to mark their attendance.
                </p>
              </div>
              <div class="col-md-6 text-end">
                <form method="POST" id="attendance-control-form" style="display: inline;">
                  {% csrf_token %}
                  <button type="button" id="start-attendance-btn" class="btn btn-success btn-lg" style="display: none;">
                    <i class="fas fa-play-circle"></i> Start Attendance
                  </button>
                  <button type="button" id="stop-attendance-btn" class="btn btn-danger btn-lg" style="display: none;">
                    <i class="fas fa-stop-circle"></i> Stop Attendance
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Registrations List -->
        {% if registrations %}
          <div class="card shadow-sm">
            <div class="card-header">
              <h5 class="mb-0">All Registrations</h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>User</th>
                      <th>RSVP</th>
                      <th>Payment Status</th>
                      <th>Receipts</th>
                      <th>Registered</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for reg in registrations %}
                      <tr>
                        <td>{{ reg.user.get_full_name }}</td>
                        <td>{{ reg.get_rsvp_display }}</td>
                        <td>
                          <span class="badge {% if reg.payment_status == 'paid' %}bg-success{% elif reg.payment_status == 'pending' %}bg-warning{% elif reg.payment_status == 'rejected' %}bg-danger{% else %}bg-secondary{% endif %}">
                            {{ reg.get_payment_status_display }}
                          </span>
                        </td>
                        <td>
                          {% if reg.payments.exists %}
                            <div class="d-flex gap-1">
                              {% for payment in reg.payments.all %}
                                {% if payment.receipt_image %}
                                  <img src="{{ payment.receipt_image.url }}" 
                                       alt="Receipt" 
                                       style="width: 40px; height: 40px; object-fit: cover; cursor: pointer; border-radius: 4px;"
                                       class="border"
                                       data-bs-toggle="modal" 
                                       data-bs-target="#adminReceiptModal{{ payment.id }}"
                                       title="Click to view - {{ payment.get_status_display }}">
                                {% endif %}
                              {% endfor %}
                            </div>
                          {% else %}
                            <span class="text-muted">No receipts</span>
                          {% endif %}
                        </td>
                        <td>{{ reg.registered_at|date:"M d, Y" }}</td>
                        <td>
                          {% if reg.payment_status == 'pending' %}
                            <span class="badge bg-warning">
                              <i class="fas fa-clock"></i> Awaiting Payment
                            </span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        {% endif %}
      {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Attendance Summary -->
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0">Attendance Summary</h5>
        </div>
        <div class="card-body">
          <p><strong>Present:</strong> {{ present_count }}</p>
          <p><strong>Absent:</strong> {{ absent_count }}</p>
          <p><strong>Total:</strong> {{ total_scouts }}</p>
        </div>
      </div>

      <!-- Event Photos -->
      {% if photos %}
        <div class="card shadow-sm">
          <div class="card-header">
            <h5 class="mb-0">Event Photos</h5>
          </div>
          <div class="card-body">
            <div class="row">
              {% for photo in photos %}
                <div class="col-6 mb-2">
                  <img src="{{ photo.image.url }}" alt="{{ photo.caption }}" class="img-fluid rounded">
                  {% if photo.is_featured %}
                    <span class="badge bg-warning">Featured</span>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Receipt Image Modals -->
{% if user_payments %}
  {% for payment in user_payments %}
    {% if payment.receipt_image %}
      <div class="modal fade" id="receiptModal{{ payment.id }}" tabindex="-1" aria-labelledby="receiptModalLabel{{ payment.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="receiptModalLabel{{ payment.id }}">
                <i class="fas fa-receipt"></i> Payment Receipt - {{ payment.created_at|date:"M d, Y" }}
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <img src="{{ payment.receipt_image.url }}" class="img-fluid" alt="Payment Receipt">
              <div class="mt-3">
                <p><strong>Amount:</strong> ₱{{ payment.amount }}</p>
                {% if payment.reference_number %}
                  <p><strong>Reference Number:</strong> {{ payment.reference_number }}</p>
                {% endif %}
                <p><strong>Status:</strong> 
                  <span class="badge {% if payment.status == 'verified' %}bg-success{% elif payment.status == 'rejected' %}bg-danger{% else %}bg-warning{% endif %}">
                    {{ payment.get_status_display }}
                  </span>
                </p>
                {% if payment.rejection_reason %}
                  <div class="alert alert-danger">
                    <strong>Rejection Reason:</strong> {{ payment.rejection_reason }}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="modal-footer">
              <a href="{{ payment.receipt_image.url }}" target="_blank" class="btn btn-primary">
                <i class="fas fa-external-link-alt"></i> Open in New Tab
              </a>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  {% endfor %}
{% endif %}

<!-- Admin Receipt Image Modals (from registration table) -->
{% if registrations %}
  {% for reg in registrations %}
    {% for payment in reg.payments.all %}
      {% if payment.receipt_image %}
        <div class="modal fade" id="adminReceiptModal{{ payment.id }}" tabindex="-1" aria-labelledby="adminReceiptModalLabel{{ payment.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="adminReceiptModalLabel{{ payment.id }}">
                  <i class="fas fa-receipt"></i> Payment Receipt - {{ reg.user.get_full_name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body text-center">
                <img src="{{ payment.receipt_image.url }}" class="img-fluid" alt="Payment Receipt">
                <div class="mt-3">
                  <p><strong>User:</strong> {{ reg.user.get_full_name }}</p>
                  <p><strong>Amount:</strong> ₱{{ payment.amount }}</p>
                  <p><strong>Date:</strong> {{ payment.created_at|date:"M d, Y g:i A" }}</p>
                  {% if payment.reference_number %}
                    <p><strong>Reference Number:</strong> {{ payment.reference_number }}</p>
                  {% endif %}
                  <p><strong>Status:</strong> 
                    <span class="badge {% if payment.status == 'verified' %}bg-success{% elif payment.status == 'rejected' %}bg-danger{% else %}bg-warning{% endif %}">
                      {{ payment.get_status_display }}
                    </span>
                  </p>
                  {% if payment.rejection_reason %}
                    <div class="alert alert-danger">
                      <strong>Rejection Reason:</strong> {{ payment.rejection_reason }}
                    </div>
                  {% endif %}
                  {% if payment.verified_by %}
                    <p><strong>Verified by:</strong> {{ payment.verified_by.get_full_name }} on {{ payment.verification_date|date:"M d, Y" }}</p>
                  {% endif %}
                </div>
              </div>
              <div class="modal-footer">
                <a href="{{ payment.receipt_image.url }}" target="_blank" class="btn btn-primary">
                  <i class="fas fa-external-link-alt"></i> Open in New Tab
                </a>
                {% if payment.status == 'pending' %}
                  <a href="{% url 'events:verify_event_registration' event.pk reg.pk %}" class="btn btn-success">
                    <i class="fas fa-check"></i> Verify Payment
                  </a>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  {% endfor %}
{% endif %}

{% endblock %} 

{% block extra_js %}
<script>
  // Initialize Bootstrap toasts
  document.addEventListener('DOMContentLoaded', function() {
    var toastElList = [].slice.call(document.querySelectorAll('.toast'));
    var toastList = toastElList.map(function(toastEl) {
      var toast = new bootstrap.Toast(toastEl);
      toast.show();
      return toast;
    });
    
    // Open PayMongo checkout in new tab if URL exists
    {% if request.session.paymongo_checkout_url %}
      var payNowBtn = document.getElementById('pay-now-btn');
      
      // Try to open in new tab
      var newWindow = window.open('{{ request.session.paymongo_checkout_url }}', '_blank');
      
      // If popup was blocked, scroll to Pay Now button
      if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
        console.log('Popup blocked - scrolling to Pay Now button');
        if (payNowBtn) {
          setTimeout(function() {
            payNowBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            payNowBtn.focus();
          }, 500);
        }
      }
      
      // Clear session variable via AJAX
      fetch('{% url "events:clear_paymongo_session" %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json'
        }
      }).catch(function(error) {
        console.error('Error clearing session:', error);
      });
    {% endif %}

    // ======================================
    // ATTENDANCE SESSION POLLING
    // ======================================
    var attendanceCheckInterval;
    
    function checkAttendanceStatus() {
      fetch('{% url "events:check_attendance_status" event.pk %}')
        .then(response => response.json())
        .then(data => {
          // Update admin UI
          {% if user.is_admin %}
            var statusBadge = document.getElementById('admin-session-status');
            var countBadge = document.getElementById('admin-attendance-count');
            var startBtn = document.getElementById('start-attendance-btn');
            var stopBtn = document.getElementById('stop-attendance-btn');
            
            if (data.is_active) {
              statusBadge.textContent = 'Active';
              statusBadge.className = 'badge bg-success';
              startBtn.style.display = 'none';
              stopBtn.style.display = 'inline-block';
            } else {
              statusBadge.textContent = 'Inactive';
              statusBadge.className = 'badge bg-secondary';
              startBtn.style.display = 'inline-block';
              stopBtn.style.display = 'none';
            }
            
            countBadge.textContent = data.attendance_count;
          {% endif %}
          
          // Update student UI
          {% if user.is_authenticated and not user.is_admin %}
            var statusMessage = document.getElementById('attendance-status-message');
            var markBtn = document.getElementById('mark-attendance-btn');
            var successMessage = document.getElementById('attendance-success-message');
            
            if (data.has_attended) {
              // Already marked attendance
              statusMessage.style.display = 'none';
              markBtn.style.display = 'none';
              successMessage.style.display = 'block';
            } else if (!data.is_eligible) {
              // Not eligible (not registered or payment pending)
              statusMessage.innerHTML = '<p class="text-warning"><i class="fas fa-exclamation-triangle"></i> You need to be registered and have payment verified to mark attendance.</p>';
              markBtn.style.display = 'none';
            } else if (data.is_active) {
              // Session active, show button
              statusMessage.innerHTML = '<p class="text-success"><i class="fas fa-check-circle"></i> Attendance session is now open!</p>';
              markBtn.style.display = 'inline-block';
            } else {
              // Session not active
              statusMessage.innerHTML = '<p class="text-muted"><i class="fas fa-clock"></i> Attendance session is not currently active. Please wait for the admin to start the session.</p>';
              markBtn.style.display = 'none';
            }
          {% endif %}
        })
        .catch(error => {
          console.error('Error checking attendance status:', error);
        });
    }
    
    // Check status immediately and then every 5 seconds
    checkAttendanceStatus();
    attendanceCheckInterval = setInterval(checkAttendanceStatus, 5000);
    
    // Admin: Start attendance session
    {% if user.is_admin %}
    document.getElementById('start-attendance-btn').addEventListener('click', function() {
      if (!confirm('Start attendance session for this event? Students will be notified.')) return;
      
      fetch('{% url "events:start_attendance_session" event.pk %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        showToast('success', 'Attendance session started! Students have been notified.');
        checkAttendanceStatus();
      })
      .catch(error => {
        showToast('danger', 'Error starting session: ' + error);
      });
    });
    
    // Admin: Stop attendance session
    document.getElementById('stop-attendance-btn').addEventListener('click', function() {
      if (!confirm('Stop attendance session? Students will no longer be able to mark attendance.')) return;
      
      fetch('{% url "events:stop_attendance_session" event.pk %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        showToast('info', 'Attendance session stopped.');
        checkAttendanceStatus();
      })
      .catch(error => {
        showToast('danger', 'Error stopping session: ' + error);
      });
    });
    {% endif %}
    
    // Student: Mark attendance
    {% if user.is_authenticated and not user.is_admin %}
    var markAttendanceBtn = document.getElementById('mark-attendance-btn');
    if (markAttendanceBtn) {
      markAttendanceBtn.addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Marking...';
        
        fetch('{% url "events:mark_my_attendance" event.pk %}', {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast('success', data.message + (data.certificate_generated ? ' Certificate generated!' : ''));
            checkAttendanceStatus();
          } else {
            showToast('danger', data.error || 'Failed to mark attendance');
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-user-check"></i> Mark My Attendance';
          }
        })
        .catch(error => {
          showToast('danger', 'Error: ' + error);
          this.disabled = false;
          this.innerHTML = '<i class="fas fa-user-check"></i> Mark My Attendance';
        });
      });
    }
    {% endif %}
    
    // Helper function to show Bootstrap toast
    function showToast(type, message) {
      var toastContainer = document.querySelector('.toast-container');
      var bgClass = type === 'success' ? 'bg-success' : 
                    type === 'danger' ? 'bg-danger' : 
                    type === 'info' ? 'bg-info' : 'bg-warning';
      
      var icon = type === 'success' ? 'fa-check-circle' : 
                 type === 'danger' ? 'fa-exclamation-circle' : 
                 type === 'info' ? 'fa-info-circle' : 'fa-exclamation-triangle';
      
      var toastHtml = `
        <div class="toast align-items-center text-white border-0 ${bgClass}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="4000">
          <div class="d-flex">
            <div class="toast-body">
              <i class="fas ${icon} me-2"></i>${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      `;
      
      toastContainer.insertAdjacentHTML('beforeend', toastHtml);
      var newToast = toastContainer.lastElementChild;
      var toast = new bootstrap.Toast(newToast);
      toast.show();
      
      // Remove from DOM after hidden
      newToast.addEventListener('hidden.bs.toast', function() {
        newToast.remove();
      });
    }
  });
</script>
{% endblock %}

<style>
  {% if user.is_authenticated and user.registration_status != 'active' %}
  .container.py-4 > *:not(#event-blur-overlay) {
    filter: blur(6px) brightness(0.8);
    pointer-events: none;
    user-select: none;
  }
  {% endif %}
  
  /* Pulse animation for Pay Now button */
  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
    }
  }
  
  .pulse-animation {
    animation: pulse 2s infinite;
  }
</style> 