{% extends 'base_sidebar.html' %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0"><i class="fas fa-user-plus me-2"></i>Complete Your Registration</h3>
        </div>
        <div class="card-body">
          
          <!-- Registration Status -->
          <div class="alert 
            {% if user.registration_status == 'payment_verified' or user.registration_status == 'active' %}alert-success
            {% elif user.registration_status == 'pending_payment' %}alert-warning
            {% elif user.registration_status == 'payment_submitted' %}alert-info
            {% else %}alert-secondary{% endif %} mb-4">
            <h5 class="alert-heading">
              {% if user.registration_status == 'payment_verified' or user.registration_status == 'active' %}
                <i class="fas fa-check-circle"></i> Registration Complete
              {% elif user.registration_status == 'pending_payment' %}
                <i class="fas fa-exclamation-triangle"></i> Payment Required
              {% else %}
                <i class="fas fa-clock"></i> Payment Processing
              {% endif %}
            </h5>
            <p class="mb-0">
              {% if user.registration_status == 'payment_verified' or user.registration_status == 'active' %}
                Your registration payment has been verified. You are now an active member!
              {% elif user.registration_status == 'pending_payment' %}
                Please complete your registration payment to activate your account and access all features.
              {% else %}
                Your payment is being processed. This usually takes 5-30 seconds.
              {% endif %}
            </p>
          </div>

          <!-- Payment Information -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Payment Information</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Registration Fee:</strong> ₱{{ user.registration_amount_required }}</p>
                  <p><strong>Amount Paid:</strong> ₱{{ user.registration_total_paid }}</p>
                  <p><strong>Amount Remaining:</strong> ₱{{ user.registration_amount_remaining }}</p>
                  <p><strong>User ID:</strong> {{ user.id }}</p>
                </div>
                <div class="col-md-6">
                  <div class="alert alert-info">
                    <h6><i class="fas fa-shield-alt me-2"></i>Secure Payment via PayMongo</h6>
                    <p class="small mb-0">
                      Pay securely using GCash or Maya. Your payment will be verified automatically within 5-30 seconds.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment History -->
          {% if payments %}
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Payment History</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Payment Method</th>
                        <th>Status</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for payment in payments %}
                        <tr>
                          <td>{{ payment.created_at|date:"M d, Y h:i A" }}</td>
                          <td>₱{{ payment.amount }}</td>
                          <td>
                            {% if payment.payment_method == 'paymongo_gcash' %}
                              <span class="badge bg-success">GCash (PayMongo)</span>
                            {% elif payment.payment_method == 'paymongo_maya' %}
                              <span class="badge bg-info">Maya (PayMongo)</span>
                            {% else %}
                              <span class="badge bg-secondary">Manual</span>
                            {% endif %}
                          </td>
                          <td>
                            {% if payment.status == 'verified' %}
                              <span class="badge bg-success"><i class="fas fa-check"></i> Verified</span>
                            {% elif payment.status == 'pending' %}
                              <span class="badge bg-warning"><i class="fas fa-clock"></i> Pending</span>
                            {% elif payment.status == 'processing' %}
                              <span class="badge bg-info"><i class="fas fa-spinner"></i> Processing</span>
                            {% elif payment.status == 'failed' %}
                              <span class="badge bg-danger"><i class="fas fa-times"></i> Failed</span>
                            {% else %}
                              <span class="badge bg-secondary">{{ payment.get_status_display }}</span>
                            {% endif %}
                          </td>
                          <td>
                            {% if payment.status == 'pending' and payment.paymongo_checkout_url %}
                              <a href="{{ payment.paymongo_checkout_url }}" target="_blank" class="btn btn-sm btn-primary">
                                <i class="fas fa-credit-card"></i> Pay Now
                              </a>
                            {% elif payment.receipt_image %}
                              <a href="{{ payment.receipt_image.url }}" target="_blank" class="btn btn-sm btn-info">
                                <i class="fas fa-image"></i> Receipt
                              </a>
                            {% else %}
                              -
                            {% endif %}
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          {% endif %}

          <!-- Pay Now Button (if pending payment exists) -->
          {% if user.registration_amount_remaining > 0 %}
            {% for payment in payments %}
              {% if payment.status == 'pending' and payment.paymongo_checkout_url %}
                <div class="card border-success mb-4">
                  <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-qrcode me-2"></i>Complete Your Payment</h5>
                  </div>
                  <div class="card-body text-center">
                    <p class="lead">Click the button below to pay ₱{{ payment.amount }} via PayMongo</p>
                    <a href="{{ payment.paymongo_checkout_url }}" 
                       target="_blank" 
                       class="btn btn-success btn-lg pulse-button" 
                       id="payNowBtn">
                      <i class="fas fa-credit-card me-2"></i>Pay Now with GCash/Maya
                    </a>
                    <p class="text-muted mt-3 small">
                      <i class="fas fa-info-circle"></i> You'll be redirected to PayMongo's secure payment page. 
                      Scan the QR code with your GCash or Maya app.
                    </p>
                    <p class="text-muted small">
                      <i class="fas fa-shield-alt"></i> Payment is automatically verified within 5-30 seconds. 
                      You can close this page after payment.
                    </p>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            <div class="alert alert-success text-center">
              <i class="fas fa-check-circle fa-3x mb-3"></i>
              <h4>Registration Complete!</h4>
              <p class="mb-0">Your payment has been verified. Welcome to Boy Scout System!</p>
              <a href="{% url 'home' %}" class="btn btn-primary mt-3">
                <i class="fas fa-home me-2"></i>Go to Dashboard
              </a>
            </div>
          {% endif %}

          <!-- Notes -->
          {% if user.registration_notes %}
            <div class="card mt-4">
              <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Administrator Notes</h5>
              </div>
              <div class="card-body">
                <p class="mb-0">{{ user.registration_notes }}</p>
              </div>
            </div>
          {% endif %}

        </div>
      </div>
    </div>
  </div>
</div>

<style>
.pulse-button {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(25, 135, 84, 0);
  }
}
</style>

<script>
// Auto-scroll to Pay Now button if it exists
window.addEventListener('DOMContentLoaded', function() {
  const payNowBtn = document.getElementById('payNowBtn');
  if (payNowBtn) {
    payNowBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
});
</script>

{% endblock %} 