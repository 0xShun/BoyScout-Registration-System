{% extends 'base_sidebar.html' %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header">
          <h3 class="mb-0">Complete Your Registration</h3>
        </div>
        <div class="card-body">
          
          <!-- Registration Status -->
          <div class="alert 
            {% if user.registration_status == 'payment_verified' %}alert-success
            {% elif user.registration_status == 'active' %}alert-primary
            {% elif user.registration_status == 'payment_submitted' or user.registration_status == 'partial_payment' or user.registration_status == 'pending_payment' %}alert-warning
            {% else %}alert-secondary{% endif %} mb-4">
            <h5 class="alert-heading">
              {% if user.registration_status == 'payment_submitted' or user.registration_status == 'partial_payment' %}
                <i class="fas fa-clock"></i> Payment Submitted - Pending Verification
              {% else %}
                <i class="fas fa-exclamation-triangle"></i> Registration Payment Required
              {% endif %}
            </h5>
            <p class="mb-0">
              {% if user.registration_status == 'payment_submitted' or user.registration_status == 'partial_payment' %}
                Your registration payment has been submitted and is being reviewed by an administrator. <br>
                <strong>You can continue using your account and log in at any time.</strong> Once your payment is verified, you will become a fully active member.
              {% else %}
                To complete your registration, please submit a payment receipt for the registration fee.<br>
                <strong>You can already log in and use your account while waiting for payment verification.</strong>
              {% endif %}
            </p>
          </div>

          <!-- Payment Information -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Payment Information</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Registration Fee Required:</strong> ₱{{ user.registration_amount_required }}</p>
                  <p><strong>Amount Paid:</strong> ₱{{ user.registration_total_paid }}</p>
                  <p><strong>Amount Remaining:</strong> ₱{{ user.registration_amount_remaining }}</p>
                  <p><strong>Reference:</strong> REG-{{ user.id }}</p>
                </div>
                <div class="col-md-6">
                  {% if registration_qr_code %}
                    <div class="text-center">
                      <h6>Registration Payment QR Code</h6>
                      <p class="small text-muted">Scan with GCash, PayMaya, or any QR-PH compatible app</p>
                      <div class="border rounded p-3 bg-light">
                        <h6 class="mb-3">Scan to Pay</h6>
                        <img src="{{ registration_qr_code.url }}" alt="Registration QR Code" class="img-fluid" style="max-width: 200px; max-height: 200px;">
                        <p class="small text-muted mt-2">Use your mobile payment app to scan this QR code</p>
                      </div>
                    </div>
                  {% else %}
                    <div class="alert alert-warning">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      QR code not yet configured by admin. Please contact the administrator.
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Payment History -->
          {% if payments %}
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Payment History</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Reference #</th>
                        <th>Status</th>
                        <th>Receipt</th>
                        <th>Notes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for payment in payments %}
                        <tr>
                          <td>{{ payment.created_at|date:"M d, Y" }}</td>
                          <td>₱{{ payment.amount }}</td>
                          <td>{{ payment.reference_number|default:"-" }}</td>
                          <td>
                            <span class="badge {% if payment.status == 'verified' %}bg-success{% elif payment.status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                              {{ payment.get_status_display }}
                            </span>
                            {% if payment.status == 'rejected' and payment.rejection_reason %}
                              <br><small class="text-danger">{{ payment.rejection_reason }}</small>
                            {% endif %}
                          </td>
                          <td>
                            {% if payment.receipt_image %}
                              <a href="{{ payment.receipt_image.url }}" target="_blank" class="btn btn-sm btn-info">
                                <i class="fas fa-image"></i> View
                              </a>
                            {% else %}
                              <span class="text-muted">No receipt</span>
                            {% endif %}
                          </td>
                          <td>{{ payment.notes|default:"-" }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          {% endif %}

          <!-- Add New Payment Form -->
          {% if user.registration_amount_remaining > 0 %}
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Add New Payment</h5>
              </div>
              <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                  {% csrf_token %}
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="amount" class="form-label">Payment Amount</label>
                        <input type="number" class="form-control" id="amount" name="amount" 
                               step="0.01" min="0.01" max="{{ user.registration_amount_remaining }}" 
                               placeholder="Enter amount paid" required>
                        <div class="form-text">
                          Maximum amount: ₱{{ user.registration_amount_remaining }}
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="reference_number" class="form-label">Reference Number <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="reference_number" name="reference_number" 
                               placeholder="Enter payment reference number" required>
                        <div class="form-text">
                          Enter the reference number from your payment receipt
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-12">
                      <div class="mb-3">
                        <label for="receipt" class="form-label">Payment Receipt <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="receipt" name="receipt" accept="image/jpeg,image/png,application/pdf" required>
                        <div class="form-text">
                          Upload a clear screenshot or photo of your payment receipt (JPG, PNG, or PDF, max 10MB).
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="notes" class="form-label">Notes (optional)</label>
                    <textarea class="form-control" id="notes" name="notes" rows="2" 
                              placeholder="Add any notes about this payment..."></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-upload"></i> Submit Payment
                  </button>
                </form>
              </div>
            </div>
          {% endif %}

          <!-- Admin Notes -->
          {% if user.registration_notes %}
            <div class="card mt-4">
              <div class="card-header">
                <h5 class="mb-0">Administrator Notes</h5>
              </div>
              <div class="card-body">
                <p class="mb-0">{{ user.registration_notes }}</p>
              </div>
            </div>
          {% endif %}

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} 