{% extends 'base_sidebar.html' %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      {% if request.user.is_authenticated and request.user.is_teacher and user.managed_by == request.user %}
        <!-- Teacher viewing student's payment -->
        <div class="mb-3">
          <a href="{% url 'accounts:teacher_student_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to My Students
          </a>
        </div>
      {% endif %}
      
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0">
            <i class="fas fa-user-plus me-2"></i>
            {% if request.user.is_authenticated and request.user.is_teacher and user.managed_by == request.user %}
              Registration Payment for {{ user.get_full_name }}
            {% else %}
              Complete Your Registration
            {% endif %}
          </h3>
        </div>
        <div class="card-body">
          
          <!-- Registration Status -->
          <div class="alert 
            {% if user.registration_status == 'payment_verified' or user.registration_status == 'active' %}alert-success
            {% elif user.registration_status == 'pending_payment' %}alert-warning
            {% elif user.registration_status == 'payment_submitted' %}alert-info
            {% else %}alert-secondary{% endif %} mb-4">
            <h5 class="alert-heading">
              {% if user.registration_status == 'payment_verified' or user.registration_status == 'active' %}
                <i class="fas fa-check-circle"></i> Registration Complete
              {% elif user.registration_status == 'pending_payment' %}
                <i class="fas fa-exclamation-triangle"></i> Payment Required
              {% else %}
                <i class="fas fa-clock"></i> Payment Processing
              {% endif %}
            </h5>
            <p class="mb-0">
              {% if user.registration_status == 'payment_verified' or user.registration_status == 'active' %}
                {% if request.user.is_authenticated and request.user.is_teacher and user.managed_by == request.user %}
                  The registration payment has been verified. {{ user.get_full_name }} is now an active member!
                {% else %}
                  Your registration payment has been verified. You are now an active member!
                {% endif %}
              {% elif user.registration_status == 'pending_payment' %}
                {% if request.user.is_authenticated and request.user.is_teacher and user.managed_by == request.user %}
                  Please complete the registration payment to activate {{ user.get_full_name }}'s account.
                {% else %}
                  Please complete your registration payment to activate your account and access all features.
                {% endif %}
              {% else %}
                {% if request.user.is_authenticated and request.user.is_teacher and user.managed_by == request.user %}
                  The payment is being processed. This usually takes 5-30 seconds.
                {% else %}
                  Your payment is being processed. This usually takes 5-30 seconds.
                {% endif %}
              {% endif %}
            </p>
          </div>

          <!-- Payment Information -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Payment Information</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Registration Fee:</strong> ‚Ç±{{ user.registration_amount_required }}</p>
                  <p><strong>Amount Paid:</strong> ‚Ç±{{ user.registration_total_paid }}</p>
                  <p><strong>Amount Remaining:</strong> ‚Ç±{{ user.registration_amount_remaining }}</p>
                  <p><strong>User ID:</strong> {{ user.id }}</p>
                </div>
                <div class="col-md-6">
                  <div class="alert alert-info">
                    <h6><i class="fas fa-shield-alt me-2"></i>Secure Payment via PayMongo</h6>
                    <p class="small mb-0">
                      Pay securely using GCash or Maya. Your payment will be verified automatically within 5-30 seconds.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment History -->
          {% if payments %}
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Payment History</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Payment Method</th>
                        <th>Status</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for payment in payments %}
                        <tr>
                          <td>{{ payment.created_at|date:"M d, Y h:i A" }}</td>
                          <td>‚Ç±{{ payment.amount }}</td>
                          <td>
                            {% if payment.payment_method == 'paymongo_gcash' %}
                              <span class="badge bg-success">GCash (PayMongo)</span>
                            {% elif payment.payment_method == 'paymongo_maya' %}
                              <span class="badge bg-info">Maya (PayMongo)</span>
                            {% else %}
                              <span class="badge bg-secondary">Manual</span>
                            {% endif %}
                          </td>
                          <td>
                            {% if payment.status == 'verified' %}
                              <span class="badge bg-success"><i class="fas fa-check"></i> Verified</span>
                            {% elif payment.status == 'pending' %}
                              <span class="badge bg-warning"><i class="fas fa-clock"></i> Pending</span>
                            {% elif payment.status == 'processing' %}
                              <span class="badge bg-info"><i class="fas fa-spinner"></i> Processing</span>
                            {% elif payment.status == 'failed' %}
                              <span class="badge bg-danger"><i class="fas fa-times"></i> Failed</span>
                            {% else %}
                              <span class="badge bg-secondary">{{ payment.get_status_display }}</span>
                            {% endif %}
                          </td>
                          <td>
                            {% if payment.status == 'pending' and payment.paymongo_checkout_url %}
                              <a href="{{ payment.paymongo_checkout_url }}" target="_blank" class="btn btn-sm btn-primary">
                                <i class="fas fa-credit-card"></i> Pay Now
                              </a>
                            {% elif payment.receipt_image %}
                              <a href="{{ payment.receipt_image.url }}" target="_blank" class="btn btn-sm btn-info">
                                <i class="fas fa-image"></i> Receipt
                              </a>
                            {% else %}
                              -
                            {% endif %}
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          {% endif %}

          <!-- Pay Now Button (if pending payment exists) -->
          {% if user.registration_amount_remaining > 0 %}
            {% with pending_payment=payments|first %}
              {% if pending_payment.status == 'pending' and pending_payment.paymongo_checkout_url %}
                <div class="card border-success mb-4">
                  <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-qrcode me-2"></i>Complete Your Payment</h5>
                  </div>
                  <div class="card-body text-center">
                    <p class="lead">Click the button below to pay ‚Ç±{{ pending_payment.amount }} via PayMongo</p>
                    <a href="{{ pending_payment.paymongo_checkout_url }}" 
                       target="_blank" 
                       class="btn btn-success btn-lg pulse-button" 
                       id="payNowBtn">
                      <i class="fas fa-credit-card me-2"></i>Pay Now with GCash/Maya
                    </a>
                    <p class="text-muted mt-3 small">
                      <i class="fas fa-info-circle"></i> You'll be redirected to PayMongo's secure payment page. 
                      Scan the QR code with your GCash or Maya app.
                    </p>
                    <p class="text-muted small">
                      <i class="fas fa-shield-alt"></i> Payment is automatically verified within 5-30 seconds. 
                      You can close this page after payment.
                    </p>
                    
                    <!-- Link expired? Create new payment -->
                    <hr>
                    <p class="text-muted small mb-2">
                      <i class="fas fa-clock"></i> Payment link expires after 1 hour. If the link doesn't work:
                    </p>
                    <form method="post" style="display: inline;">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="create_new_payment">
                      <button type="submit" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-redo me-1"></i>Create New Payment Link
                      </button>
                    </form>
                  </div>
                </div>
              {% else %}
                <!-- No pending payment or payment expired/failed - show create new payment button -->
                <div class="card border-warning mb-4">
                  <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>No Active Payment Link</h5>
                  </div>
                  <div class="card-body text-center">
                    <p class="lead">
                      {% if pending_payment.status == 'expired' %}
                        Your previous payment link has expired.
                      {% elif pending_payment.status == 'failed' %}
                        Your previous payment failed.
                      {% else %}
                        No active payment link found.
                      {% endif %}
                    </p>
                    <p>Create a new payment link to complete your registration.</p>
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="create_new_payment">
                      <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus-circle me-2"></i>Create New Payment Link
                      </button>
                    </form>
                  </div>
                </div>
              {% endif %}
            {% endwith %}
          {% else %}
            <div class="alert alert-success text-center">
              <i class="fas fa-check-circle fa-3x mb-3"></i>
              <h4>Registration Complete!</h4>
              {% if request.user.is_authenticated and request.user.is_teacher and user.managed_by == request.user %}
                <p class="mb-0">The payment has been verified. {{ user.get_full_name }} is now an active member!</p>
                <a href="{% url 'accounts:teacher_student_list' %}" class="btn btn-primary mt-3">
                  <i class="bi bi-people me-2"></i>Back to My Students
                </a>
              {% else %}
                <p class="mb-0">Your payment has been verified. Welcome to Boy Scout System!</p>
                <a href="{% url 'home' %}" class="btn btn-primary mt-3">
                  <i class="fas fa-home me-2"></i>Go to Dashboard
                </a>
              {% endif %}
            </div>
          {% endif %}

          <!-- Notes -->
          {% if user.registration_notes %}
            <div class="card mt-4">
              <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Administrator Notes</h5>
              </div>
              <div class="card-body">
                <p class="mb-0">{{ user.registration_notes }}</p>
              </div>
            </div>
          {% endif %}

        </div>
      </div>
    </div>
  </div>
</div>

<style>
.pulse-button {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(25, 135, 84, 0);
  }
}
</style>

<script>
console.log("üéØ Registration Payment Page Loaded");
console.log("User ID: {{ user.id }}");
console.log("Registration Status: {{ user.registration_status }}");
console.log("Amount Remaining: ‚Ç±{{ user.registration_amount_remaining }}");

// Auto-scroll to Pay Now button if it exists
window.addEventListener('DOMContentLoaded', function() {
  const payNowBtn = document.getElementById('payNowBtn');
  if (payNowBtn) {
    console.log("‚úÖ Pay Now button found, scrolling to it");
    payNowBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  
  // Auto-refresh to check payment status every 10 seconds
  {% if user.registration_amount_remaining > 0 %}
  console.log("‚è∞ Starting auto-refresh (every 10 seconds) to check payment status...");
  let refreshCount = 0;
  const maxRefreshes = 30; // Stop after 5 minutes (30 * 10 seconds)
  
  const refreshInterval = setInterval(function() {
    refreshCount++;
    console.log(`üîÑ Auto-refresh #${refreshCount} - Checking payment status...`);
    
    // Reload the page to check if payment was verified
    if (refreshCount >= maxRefreshes) {
      console.log("‚è±Ô∏è Stopped auto-refresh after 5 minutes");
      clearInterval(refreshInterval);
    } else {
      location.reload();
    }
  }, 10000); // 10 seconds
  
  // Stop auto-refresh if user leaves the page
  window.addEventListener('beforeunload', function() {
    console.log("üõë Stopping auto-refresh - user leaving page");
    clearInterval(refreshInterval);
  });
  {% else %}
  console.log("‚úÖ Payment already verified - no auto-refresh needed");
  {% endif %}
});

// Log when payment link is clicked
document.addEventListener('click', function(e) {
  if (e.target.closest('a[href*="paymongo"]')) {
    console.log("üí≥ User clicked Pay Now button - opening PayMongo checkout");
  }
});
</script>

{% endblock %} 