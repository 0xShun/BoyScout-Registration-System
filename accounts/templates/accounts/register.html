{% extends 'base.html' %}
{% load static %}
{% block content %}
  <div class="registration-container">
    <div class="row justify-content-center">
      <div class="col-lg-9 col-md-10">
        <div class="registration-card bg-white p-5 rounded-4 shadow-lg">
          <div class="mb-5 text-center">
            <div class="mb-3">
              <img src="{% static 'img/logo1.png' %}" alt="Scout Logo" style="height: 60px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
            </div>
            <h2 class="fw-bold mb-2" style="color: #1e3a8a; font-size: 2.5rem;">Create Account</h2>
            <p class="text-muted" style="font-size: 1.1rem;">Join ScoutConnect - Begin your scouting journey</p>
          </div>
      
          <!-- Registration Type Toggle Switch -->
          <div class="registration-type-card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h5 class="mb-1 fw-bold">
                    <i class="fas fa-user me-2 text-primary" id="registrationTypeIcon"></i>
                    <span id="registrationTypeLabel">Single Registration</span>
                  </h5>
                  <small class="text-muted" style="font-size: 0.95rem;" id="registrationTypeDesc">Register one student</small>
                </div>
                <div class="form-check form-switch form-switch-lg">
                  <input class="form-check-input custom-switch" type="checkbox" role="switch" id="registrationTypeSwitch">
                </div>
              </div>
            </div>
          </div>
      
      <form method="post" id="registrationForm">
        {% csrf_token %}
        <input type="hidden" name="registration_type" id="registrationType" value="single">
        
        <!-- Single Registration Form (default) -->
        <div id="singleRegistrationForm">
          <!-- Display Fixed Registration Fee -->
          <div class="fee-card mb-4">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1 fw-bold"><i class="fas fa-tag me-2"></i>Registration Fee</h6>
                <small class="text-muted">Set by administrator</small>
              </div>
              <div class="text-end">
                <h3 class="mb-0 fw-bold" style="color: #1e3a8a;">‚Ç±500.00</h3>
              </div>
            </div>
          </div>
          
          {% for field in form %}
            <div class="mb-3">
              <label for="{{ field.id_for_label }}" class="form-label fw-bold">{{ field.label }}</label>
              {{ field }}
              {% if field.help_text %}
                <div class="form-text">{{ field.help_text }}</div>
              {% endif %}
              {% for error in field.errors %}
                <div class="text-danger">{{ error }}</div>
              {% endfor %}
            </div>
          {% endfor %}
          
          <!-- Payment Information -->
          <div class="payment-info-card mb-4">
            <h6 class="fw-bold mb-3"><i class="fas fa-mobile-alt me-2"></i>Instant Payment - No Receipt Upload Needed!</h6>
            <p class="mb-3">After registration, you'll be redirected to pay securely via:</p>
            <div class="payment-methods mb-3">
              <div class="payment-badge"><i class="fab fa-google-wallet"></i> GCash</div>
              <div class="payment-badge"><i class="fas fa-wallet"></i> PayMaya</div>
              <div class="payment-badge"><i class="fas fa-mobile-alt"></i> GrabPay</div>
            </div>
            <ul class="payment-features mb-3">
              <li><i class="fas fa-check-circle text-success me-2"></i><strong>Instant verification</strong> - No waiting for admin approval</li>
              <li><i class="fas fa-shield-alt text-success me-2"></i><strong>Secure payment</strong> - Protected by PayMongo</li>
              <li><i class="fas fa-qrcode text-success me-2"></i><strong>Easy process</strong> - Just scan QR code in your e-wallet app</li>
            </ul>
            <p class="mb-0 text-muted small"><i class="fas fa-info-circle me-1"></i>Your account will be activated automatically after payment!</p>
          </div>
          
          <button type="submit" class="btn btn-register w-100 py-3 fw-bold">
            <i class="fas fa-user-plus me-2"></i>Register & Proceed to Payment
          </button>
        </div>
        
        <!-- Batch Registration Form (hidden by default) -->
        <div id="batchRegistrationForm" style="display: none;">
          <!-- Registrar Information -->
          <div class="card mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="fas fa-chalkboard-teacher"></i> Teacher/Registrar Information</h5>
            </div>
            <div class="card-body">
              {% if registrar_form %}
                {% for field in registrar_form %}
                  <div class="mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label fw-bold">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}
                      <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                    {% for error in field.errors %}
                      <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                  </div>
                {% endfor %}
              {% endif %}
            </div>
          </div>
          
          <!-- Students Section -->
          <div class="card mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="fas fa-users"></i> Students Information</h5>
              <span class="badge bg-light text-dark" id="studentCount">0 students</span>
            </div>
            <div class="card-body">
              <p class="text-muted mb-3">
                <i class="fas fa-info-circle"></i> Enter each student's details below. All students will be registered with active accounts immediately.
              </p>
              
              <!-- Dynamic student forms will be inserted here -->
              <div id="studentFormsContainer"></div>
              
              <!-- Info about the process -->
              <div class="alert alert-info mt-3">
                <h6 class="alert-heading">üìù How Batch Registration Works:</h6>
                <ol class="mb-0 ps-3">
                  <li>Enter the number of students above to generate the forms</li>
                  <li>Fill in each student's details (all fields required)</li>
                  <li>Click submit - all student accounts will be created immediately</li>
                  <li>You'll be redirected to PayMongo payment page</li>
                  <li>Each student will receive welcome email with their login credentials</li>
                </ol>
              </div>
            </div>
          </div>
          
          <!-- Total Amount Display -->
          <div class="alert alert-info mb-4">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0"><i class="fas fa-calculator"></i> Total Registration Fee</h6>
                <small class="text-muted"><span id="totalStudents">0</span> students √ó ‚Ç±500.00</small>
              </div>
              <div class="text-end">
                <h4 class="mb-0 text-primary" id="totalAmount">‚Ç±0.00</h4>
              </div>
            </div>
          </div>
          
          <!-- Batch Payment Information -->
          <div class="alert alert-primary">
            <h6 class="alert-heading"><i class="fas fa-mobile-alt"></i> Batch Payment - One Payment for All Students!</h6>
            <p class="mb-2">After submitting student details, you'll complete payment via:</p>
            <div class="d-flex gap-3 justify-content-center my-3">
              <span class="badge bg-light text-dark fs-6">GCash</span>
              <span class="badge bg-light text-dark fs-6">PayMaya</span>
              <span class="badge bg-light text-dark fs-6">GrabPay</span>
            </div>
            <ul class="mb-2">
              <li><strong>Accounts activated immediately</strong> - Students can login right away</li>
              <li><strong>Single payment</strong> - Pay for all students at once</li>
              <li><strong>Email notifications</strong> - Each student receives their login credentials</li>
            </ul>
            <p class="mb-0 small"><i class="fas fa-info-circle"></i> All student accounts will be active immediately after you click submit!</p>
          </div>
          
          <button type="submit" class="btn btn-success w-100 py-3 fw-bold mt-3" id="batchSubmitBtn" disabled>
            <i class="fas fa-user-plus me-2"></i> Create <span id="submitStudentCount">0</span> Student Accounts & Proceed to Payment
          </button>
          
          <div id="batchValidationMessage" class="alert alert-warning mt-3" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i> Please enter the number of students (1-50) to proceed.
          </div>
        </div>
      </form>
      
          <div class="text-center mt-4">
            <p class="text-muted mb-2">Already have an account?</p>
            <a href="{% url 'accounts:login' %}" class="btn btn-outline-primary rounded-pill px-4 py-2">
              <i class="fas fa-sign-in-alt me-2"></i>Sign In
            </a>
          </div>
          
          <div class="text-center mt-4">
            <a href="/" class="text-muted text-decoration-none">
              <i class="fas fa-arrow-left me-2"></i>Back to Home
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .registration-container {
      min-height: 100vh;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      padding: 3rem 0;
    }
    
    .registration-card {
      border: none;
    }
    
    .rounded-4 {
      border-radius: 1.5rem !important;
    }
    
    .registration-type-card {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border-radius: 1rem;
      padding: 1.5rem;
      border: 2px solid #bfdbfe;
      transition: all 0.3s ease;
    }
    
    .registration-type-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }
    
    .fee-card {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 1rem;
      padding: 1.5rem;
      border: 2px solid #fbbf24;
    }
    
    .payment-info-card {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border-radius: 1rem;
      padding: 1.5rem;
      border: 2px solid #3b82f6;
    }
    
    .payment-methods {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .payment-badge {
      background: white;
      padding: 0.75rem 1.5rem;
      border-radius: 2rem;
      font-weight: 600;
      color: #1e3a8a;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .payment-badge:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .payment-features {
      list-style: none;
      padding-left: 0;
    }
    
    .payment-features li {
      padding: 0.5rem 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .payment-features li:last-child {
      border-bottom: none;
    }
    
    .form-control, .form-select {
      border-radius: 0.75rem;
      padding: 0.9rem 1.25rem;
      border: 2px solid #e5e7eb;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      background: #f0f9ff;
    }
    
    .form-label {
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
    }
    
    .form-text {
      font-size: 0.875em;
      color: #6b7280;
    }
    
    form p {
      margin-bottom: 0.5rem;
    }
    
    /* Custom toggle switch styling */
    .custom-switch {
      width: 60px;
      height: 30px;
      cursor: pointer;
    }
    
    .custom-switch:checked {
      background-color: #10b981;
      border-color: #10b981;
    }
    
    .custom-switch:focus {
      box-shadow: 0 0 0 0.25rem rgba(16, 185, 129, 0.25);
    }
    
    /* Buttons */
    .btn-register {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
      border: none;
      font-size: 1.1rem;
      border-radius: 3rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
    }

    .btn-register:hover {
      background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
      color: white;
    }
    
    .btn-outline-primary {
      border: 2px solid #3b82f6;
      color: #1e3a8a;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-outline-primary:hover {
      background: #3b82f6;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    /* Smooth transitions */
    #singleRegistrationForm,
    #batchRegistrationForm {
      transition: opacity 0.3s ease-in-out;
    }
    
    .alert {
      border-radius: 0.75rem;
    }
    
    .card {
      border-radius: 1rem;
      border: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .card-header {
      border-radius: 1rem 1rem 0 0 !important;
      font-weight: 600;
    }
    
    @media (max-width: 768px) {
      .registration-container {
        padding: 2rem 1rem;
      }
      
      .registration-card {
        padding: 2rem !important;
      }
    }
  </style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const input = document.querySelector("#id_phone_number");
        if (input) {
            window.intlTelInput(input, {
                initialCountry: "auto",
                geoIpLookup: function(callback) {
                    fetch("https://ipapi.co/json")
                        .then(res => res.json())
                        .then(data => callback(data.country_code))
                        .catch(() => callback("us"));
                },
                utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@25.3.1/build/js/utils.js"
            });
        }
        
        // Batch Registration - Define variables and function first
        const numberOfStudentsInput = document.getElementById('id_number_of_students');
        const studentCountBadge = document.getElementById('studentCount');
        const totalStudentsSpan = document.getElementById('totalStudents');
        const totalAmountSpan = document.getElementById('totalAmount');
        const submitStudentCount = document.getElementById('submitStudentCount');
        const batchSubmitBtn = document.getElementById('batchSubmitBtn');
        const batchValidationMessage = document.getElementById('batchValidationMessage');
        const registrationForm = document.getElementById('registrationForm');
        
        function updateBatchTotal() {
            const numStudents = parseInt(numberOfStudentsInput?.value || 0);
            if (studentCountBadge) studentCountBadge.textContent = `${numStudents} student${numStudents !== 1 ? 's' : ''}`;
            if (totalStudentsSpan) totalStudentsSpan.textContent = numStudents;
            if (submitStudentCount) submitStudentCount.textContent = numStudents;
            const total = numStudents * 500;
            if (totalAmountSpan) totalAmountSpan.textContent = `‚Ç±${total.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            // Generate student forms
            generateStudentForms(numStudents);
            
            // Enable/disable submit button based on number of students
            if (batchSubmitBtn) {
                if (numStudents > 0 && numStudents <= 50) {
                    batchSubmitBtn.disabled = false;
                    batchSubmitBtn.classList.remove('btn-secondary');
                    batchSubmitBtn.classList.add('btn-success');
                    batchSubmitBtn.style.cursor = 'pointer';
                    if (batchValidationMessage) batchValidationMessage.style.display = 'none';
                } else {
                    batchSubmitBtn.disabled = true;
                    batchSubmitBtn.classList.remove('btn-success');
                    batchSubmitBtn.classList.add('btn-secondary');
                    batchSubmitBtn.style.cursor = 'not-allowed';
                    if (batchValidationMessage) batchValidationMessage.style.display = 'block';
                }
            }
        }
        
        function generateStudentForms(numStudents) {
            const container = document.getElementById('studentFormsContainer');
            if (!container) return;
            
            // Get pre-filled data if exists (from server-side validation errors)
            const studentDataList = {{ student_data_list|safe|default:"[]" }};
            const duplicateEmails = {{ duplicate_emails|safe|default:"[]" }};
            const duplicateUsernames = {{ duplicate_usernames|safe|default:"[]" }};
            
            // Clear existing forms
            container.innerHTML = '';
            
            if (numStudents < 1 || numStudents > 50) {
                return;
            }
            
            // Generate form for each student
            for (let i = 0; i < numStudents; i++) {
                const studentData = studentDataList[i] || {};
                const emailHasError = duplicateEmails.includes(studentData.email);
                const usernameHasError = duplicateUsernames.includes(studentData.username);
                
                const studentCard = document.createElement('div');
                studentCard.className = 'card mb-3';
                studentCard.innerHTML = `
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-user-graduate"></i> Student ${i + 1}</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">First Name *</label>
                                <input type="text" name="student_${i}_first_name" class="form-control" value="${studentData.first_name || ''}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Last Name *</label>
                                <input type="text" name="student_${i}_last_name" class="form-control" value="${studentData.last_name || ''}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Email Address *</label>
                                <input type="email" name="student_${i}_email" class="form-control ${emailHasError ? 'is-invalid' : ''}" value="${studentData.email || ''}" required>
                                ${emailHasError ? '<div class="invalid-feedback">‚ùå This email already exists in the system</div>' : ''}
                                <small class="form-text text-muted">Student will receive login credentials here</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Phone Number</label>
                                <input type="tel" name="student_${i}_phone_number" class="form-control" value="${studentData.phone_number || ''}" placeholder="+639XXXXXXXXX">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Date of Birth *</label>
                                <input type="date" name="student_${i}_date_of_birth" class="form-control" value="${studentData.date_of_birth || ''}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Username *</label>
                                <input type="text" name="student_${i}_username" class="form-control ${usernameHasError ? 'is-invalid' : ''}" value="${studentData.username || ''}" required>
                                ${usernameHasError ? '<div class="invalid-feedback">‚ùå This username already exists</div>' : ''}
                                <small class="form-text text-muted">Used for login</small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Address *</label>
                            <textarea name="student_${i}_address" class="form-control" rows="2" required>${studentData.address || ''}</textarea>
                        </div>
                    </div>
                `;
                container.appendChild(studentCard);
            }
        }
        
        // Form submission validation
        if (registrationForm) {
            registrationForm.addEventListener('submit', function(e) {
                const registrationType = document.getElementById('registrationType').value;
                
                if (registrationType === 'batch') {
                    const numStudents = parseInt(numberOfStudentsInput?.value || 0);
                    
                    if (numStudents < 1 || numStudents > 50) {
                        e.preventDefault();
                        if (batchValidationMessage) {
                            batchValidationMessage.style.display = 'block';
                            batchValidationMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        alert('Please enter a valid number of students (1-50) before proceeding to payment.');
                        return false;
                    }
                }
            });
        }
        
        if (numberOfStudentsInput) {
            numberOfStudentsInput.addEventListener('input', updateBatchTotal);
            numberOfStudentsInput.addEventListener('change', updateBatchTotal);
            // Initialize on page load
            updateBatchTotal();
        } else {
            console.error('Number of students input field not found!');
        }
        
        // Registration Type Toggle Switch
        const toggleSwitch = document.getElementById('registrationTypeSwitch');
        const registrationType = document.getElementById('registrationType');
        const typeLabel = document.getElementById('registrationTypeLabel');
        const typeIcon = document.getElementById('registrationTypeIcon');
        const typeDesc = document.getElementById('registrationTypeDesc');
        const singleForm = document.getElementById('singleRegistrationForm');
        const batchForm = document.getElementById('batchRegistrationForm');
        
        if (toggleSwitch) {
      toggleSwitch.addEventListener('change', function() {
        if (this.checked) {
          // Switch to Batch Registration
          registrationType.value = 'batch';
          typeLabel.textContent = 'Batch Registration';
          typeIcon.className = 'fas fa-users me-2';
          typeDesc.textContent = 'Register multiple students (Teachers)';
          singleForm.style.display = 'none';
          batchForm.style.display = 'block';
          // Enable all inputs in batch form
          Array.from(batchForm.querySelectorAll('input, select, textarea')).forEach(function(el) {
            el.disabled = false;
          });
          // Disable all inputs in single form
          Array.from(singleForm.querySelectorAll('input, select, textarea')).forEach(function(el) {
            el.disabled = true;
          });
          updateBatchTotal();
        } else {
          // Switch to Single Registration
          registrationType.value = 'single';
          typeLabel.textContent = 'Single Registration';
          typeIcon.className = 'fas fa-user me-2';
          typeDesc.textContent = 'Register one student';
          singleForm.style.display = 'block';
          batchForm.style.display = 'none';
          // Enable all inputs in single form
          Array.from(singleForm.querySelectorAll('input, select, textarea')).forEach(function(el) {
            el.disabled = false;
          });
          // Disable all inputs in batch form
          Array.from(batchForm.querySelectorAll('input, select, textarea')).forEach(function(el) {
            el.disabled = true;
          });
        }
      });
  // On page load, ensure only visible form's fields are enabled
  const singleForm = document.getElementById('singleRegistrationForm');
  const batchForm = document.getElementById('batchRegistrationForm');
  
  // Check if we're returning from an error (batch registration preserved)
  {% if registration_type == 'batch' %}
    // Switch to batch mode
    const registrationType = document.getElementById('registrationType');
    const typeLabel = document.getElementById('registrationTypeLabel');
    const typeIcon = document.getElementById('registrationTypeIcon');
    const typeDesc = document.getElementById('registrationTypeDesc');
    const toggleSwitch = document.getElementById('registrationTypeSwitch');
    
    if (toggleSwitch) toggleSwitch.checked = true;
    if (registrationType) registrationType.value = 'batch';
    if (typeLabel) typeLabel.textContent = 'Batch Registration';
    if (typeIcon) typeIcon.className = 'fas fa-users me-2';
    if (typeDesc) typeDesc.textContent = 'Register multiple students (Teachers)';
    
    if (singleForm) {
      singleForm.style.display = 'none';
      Array.from(singleForm.querySelectorAll('input, select, textarea')).forEach(function(el) { el.disabled = true; });
    }
    if (batchForm) {
      batchForm.style.display = 'block';
      Array.from(batchForm.querySelectorAll('input, select, textarea')).forEach(function(el) { el.disabled = false; });
    }
    
    // Trigger form generation with preserved data
    updateBatchTotal();
  {% else %}
    // Enable single, disable batch by default
    if (singleForm) Array.from(singleForm.querySelectorAll('input, select, textarea')).forEach(function(el) { el.disabled = false; });
    if (batchForm) Array.from(batchForm.querySelectorAll('input, select, textarea')).forEach(function(el) { el.disabled = true; });
  {% endif %}
        }
    });
</script>
{% endblock %} 